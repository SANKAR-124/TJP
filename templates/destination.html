<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ destination.place_name }} Workspace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hero-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 200px;
            border-radius: .5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .meta {
            color: #6b7280;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container">
            <a href="/journey/{{ destination.Jid }}" class="btn btn-link text-decoration-none">&larr; Back to
                Journey</a>
            <span class="navbar-brand mb-0 h1">Workspace</span>
            <div></div>
        </div>
    </nav>

    <main class="container my-4">
        <div class="row g-4">

            <div class="col-12 col-md-8">

                <div class="hero-placeholder shadow-sm mb-4">
                    <h1 class="display-4 fw-bold">{{ destination.place_name }}</h1>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h3 class="h5 mb-0 py-2">üìñ Travel Logs</h3>
                    </div>
                    <div class="card-body">

                        {% if logs %}
                        {% for log in logs %}
                        <div class="p-3 mb-3 bg-light border rounded position-relative" id="log-{{ log.Lid }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <small class="text-muted d-block mb-2 border-bottom pb-1">
                                        üïí {{ log.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                    </small>
                                    <p class="mb-0">{{ log.note_text }}</p>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger ms-2" onclick="deleteLog({{ log.Lid }})" title="Delete log">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted">No logs yet. Write your first memory!</p>
                        {% endif %}

                        <hr>

                        <form id="logForm">
                            <div class="mb-3">
                                <label class="form-label">New Log Entry</label>
                                <textarea class="form-control" name="note" rows="3" required
                                    placeholder="What did you do here?"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Log</button>
                        </form>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h3 class="h5 mb-0 py-2">‚è∞ Reminders & Tasks</h3>
                    </div>
                    <div class="card-body">
                        {% if reminders %}
                        {% for reminder in reminders %}
                        <div class="p-3 mb-2 bg-light border rounded d-flex justify-content-between align-items-start reminder-item-{{ reminder.Rid }}"
                            id="reminder-{{ reminder.Rid }}">
                            <div style="flex: 1;">
                                <p class="mb-1"><strong>{{ reminder.rem_text }}</strong></p>
                                <small class="text-muted">Status: <span class="reminder-status-{{ reminder.Rid }}">{{
                                        reminder.status }}</span></small>
                            </div>
                            <div>
                                <button type="button"
                                    class="btn btn-sm btn-{{ 'success' if reminder.status == 0 else 'warning' }}"
                                    onclick="toggleReminder({{ reminder.Rid }})">
                                    {{ '‚úì Done' if reminder.status == 0 else '‚Üª Reopen' }}
                                </button>
                                <button type="button" class="btn btn-sm btn-danger ms-2" onclick="deleteReminder({{ reminder.Rid }})" title="Delete reminder">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted">No reminders yet. Add one below!</p>
                        {% endif %}

                        <hr>

                        <form id="reminderForm">
                            <div class="mb-3">
                                <label class="form-label">New Reminder</label>
                                <textarea class="form-control" name="rem_text" rows="2" required
                                    placeholder="What do you need to remember?"></textarea>
                            </div>
                            <input type="hidden" name="status" value="0">
                            <button type="submit" class="btn btn-primary">Add Reminder</button>
                        </form>
                    </div>
                </div>

            </div>

            <aside class="col-12 col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Destination Info</h5>
                        <ul class="list-unstyled mb-0 mt-3">
                            <li class="mb-2"><strong>Status:</strong> <span class="badge bg-primary">{{
                                    destination.visit_status }}</span></li>
                            <li class="mb-2"><strong>Visit Order:</strong> #{{ destination.visit_order }}</li>
                            <li class="mb-2"><strong>Main Destination:</strong> {% if destination.is_main %}Yes{% else
                                %}No{% endif %}</li>
                        </ul>
                    </div>
                </div>

                {% if destination.map %}
                <div class="card shadow-sm">
                    <div class="card-body p-2 text-center">
                        <a href="{{ destination.map }}" target="_blank" class="btn btn-outline-primary w-100">üó∫Ô∏è Open
                            Map Link</a>
                    </div>
                </div>
                {% endif %}
            </aside>

        </div>
    </main>

    <script>
        document.getElementById('logForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch(`/travel_log/{{ destination.Did }}`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to show the new log!
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Handle reminder form submission
        document.getElementById('reminderForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch(`/add_reminder/{{ destination.Did }}`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to show the new reminder!
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Toggle reminder status
        function toggleReminder(reminderId) {
            fetch(`/toggle_reminder/${reminderId}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const reminderEl = document.getElementById(`reminder-${reminderId}`);
                        const statusSpan = document.querySelector(`.reminder-status-${reminderId}`);
                        const toggleBtn = reminderEl.querySelector('button');

                        // Convert 0/1 back to words for the user to see
                        statusSpan.textContent = data.new_status === 0 ? "pending" : "completed";

                        // If the new status is 1 (completed)
                        if (data.new_status === 1) {
                            reminderEl.classList.add('alert-success');
                            toggleBtn.classList.remove('btn-success');
                            toggleBtn.classList.add('btn-warning');
                            toggleBtn.textContent = '‚Üª Reopen';
                        } else {
                            reminderEl.classList.remove('alert-success');
                            toggleBtn.classList.remove('btn-warning');
                            toggleBtn.classList.add('btn-success');
                            toggleBtn.textContent = '‚úì Done';
                        }
                    } else {
                        alert('Error toggling reminder. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error toggling reminder. Please try again.');
                });
        }

        // Delete log
        function deleteLog(logId) {
            if (!confirm('Are you sure you want to delete this log entry? This cannot be undone.')) return;
            
            fetch(`/delete_log/${logId}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const logEl = document.getElementById(`log-${logId}`);
                        logEl.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            logEl.remove();
                        }, 300);
                    } else {
                        alert('Error deleting log. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting log. Please try again.');
                });
        }

        // Delete reminder
        function deleteReminder(reminderId) {
            if (!confirm('Are you sure you want to delete this reminder? This cannot be undone.')) return;
            
            fetch(`/delete_reminder/${reminderId}`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const reminderEl = document.getElementById(`reminder-${reminderId}`);
                        reminderEl.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            reminderEl.remove();
                        }, 300);
                    } else {
                        alert('Error deleting reminder. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting reminder. Please try again.');
                });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>